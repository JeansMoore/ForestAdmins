
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF8" />
    
    <title>Informations avancées du pilote PostgreSQL / PostGIS &mdash; GDAL v1.9.0 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.9.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <link rel="top" title="GDAL v1.9.0 documentation" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../index.html">GDAL v1.9.0 documentation</a> &raquo;</li> 
      </ul>
    </div>


      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table des matières</a></h3>
            <ul>
<li><a class="reference internal" href="#">Informations avancées du pilote PostgreSQL / PostGIS</a><ul>
<li><a class="reference internal" href="#options-de-connexion-relie-aux-schemas-et-tables">Options de connexion relié aux schémas et tables</a></li>
<li><a class="reference internal" href="#colonnes-geometrique-multiples">Colonnes géométrique multiples</a></li>
<li><a class="reference internal" href="#couches">Couches</a></li>
<li><a class="reference internal" href="#vues-nommees">Vues nommées</a></li>
<li><a class="reference internal" href="#recuper-le-fid-d-une-feature-nouvellement-inseree">Récuper le FID d&#8217;une feature nouvellement insérée</a></li>
<li><a class="reference internal" href="#avertissements">Avertissements</a><ul>
<li><a class="reference internal" href="#exemples-avances">Exemples avancés</a></li>
<li><a class="reference internal" href="#voir-egalement">Voir également</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h3>Cette page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/ogr/formats/pg_advanced.txt"
                     rel="nofollow">Montrer la source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Recherche rapide</h3>
              <form class="search" action="../../search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="informations-avancees-du-pilote-postgresql-postgis">
<span id="gdal-ogr-formats-pg-advanced"></span><h1>Informations avancées du pilote PostgreSQL / PostGIS<a class="headerlink" href="#informations-avancees-du-pilote-postgresql-postgis" title="Lien permanent vers ce titre">¶</a></h1>
<p>L&#8217;information collectée dans cette page traite de sujet avancé, non trouvé dans
la page <a class="reference internal" href="pg.html#gdal-ogr-formats-pg"><em>PostgreSQL / PostGIS</em></a>.</p>
<div class="section" id="options-de-connexion-relie-aux-schemas-et-tables">
<h2>Options de connexion relié aux schémas et tables<a class="headerlink" href="#options-de-connexion-relie-aux-schemas-et-tables" title="Lien permanent vers ce titre">¶</a></h2>
<p>À partir de GDAL 1.8.0, l&#8217;ouverture de la base de données doit être significativement
plus rapide que dans les versions précédentes, l&#8217;utilisation des options <em>tables=</em>
ou <em>schemas=</em> ne devraient pas accélérer les choses.</p>
<p>À partir de GDAL 1.6.0, l&#8217;ensemble des tables à scanner peut être écrasé en
spécifiant <em>tables=[schema.]table[(geom_column_name)][,[schema2.]table2[(geom_column_name2)],...]</em> dans la chaîne de
connexion. Si le paramètre est trouvé, le pilote saute l&#8217;énumération des tables
comme décrite dans le paragraphe suivant.</p>
<p>À partir de GDAL 1.7.0, il est possible de restreindre les schémas qui seront
scannés lors de l&#8217;établissement de la liste des tables. Cela peut être réalisé
en spécifiant <em>schemas=schema_name[,schema_name2]</em> dans la chaîne de connections.
Cela peut aussi être un moyen d&#8217;accélérer la connexion à la base de données
PostgreSQL s&#8217;il y a beaucoup de schémas. Remarquez que si seulement un schéma
est listé, il sera aussi défini comme le schéma actif (et le nom du schéma ne
sera pas en préfixe des noms des couches). Autrement, le schéma actif sera
encore &#8216;public&#8217;, à moins que cela soit spécifié par l&#8217;option <em>active_schema=</em>.</p>
<p>À partir de GDAL 1.7.0, le schéma actif (&#8216;public&#8217; par défaut) peut être écrasé
en définissant <em>active_schema=schema_name</em> dans la chaîne de connexion. Le
schéma actif est le schéma où les tables sont créées ou recherchées lorsque leur
nom n&#8217;est pas défini en préfixe explicitement dans les noms des couches. Notez
que cela ne restreint pas les tables qui seront listées (voir l&#8217;option * schemas=*
ci-dessus). Lors de l&#8217;obtention de la liste des tables, le nom des tables dans
le schéma actif ne sera pas préfixé par le nom du schéma. Par exemple, si vous
avez la table &#8216;foo&#8217; dans le schéma public, et une table &#8216;foo&#8217; dans le schéma
&#8216;bar_schema&#8217; et que vous définissez <em>&#8216;active_schema=bar_schema</em>, deux couches
seront listées : &#8216;foo&#8217; (implicitement dans &#8216;bar_schema&#8217;) et &#8216;public.foo&#8217;.</p>
</div>
<div class="section" id="colonnes-geometrique-multiples">
<h2>Colonnes géométrique multiples<a class="headerlink" href="#colonnes-geometrique-multiples" title="Lien permanent vers ce titre">¶</a></h2>
<p>À partir de GDAL 1.6.0, le pilote PostgreSQL gère l&#8217;accès aux tables avec
plusieurs colonnes géométriques PostGIS. Pour de telles tables, il y aura autant
de couches reportées que de nombre de colonnes géométriques listées pour cette
table dans la table <em>geometry_columns</em>. Par exemple, si une table &#8216;foo&#8217; a deux
colonnes géométriques &#8216;bar&#8217; et &#8216;baz&#8217;, deux couches seront reportées : &#8216;foo(bar)&#8217;
et &#8216;foo(baz)&#8217;. Pour une compatibilité arrière, si une table possède une seule
colonne géométrique, le nom de la couche est le nom de la table. Aussi si une
table &#8216;foo&#8217; possède plusieurs colonnes géométriques, avec une appelée
&#8216;wkb_geometry&#8217;, la couche correspondante à cette colonne géométrique sera
simplement reportée comme &#8216;foo&#8217;. Soyez attentif - le comportement lors de la
création, mise à jour ou suppression de couches qui sont basées sur des tables
avec de multiples colonnes géométriques PostGIS est connue pour avoir des effets
secondaires (mal connu) sur les autres couches puisqu&#8217;elles sont intimement liées.
Par conséquent, cette possibilité doit être utilisée essentiellement en lecture
seule.</p>
</div>
<div class="section" id="couches">
<h2>Couches<a class="headerlink" href="#couches" title="Lien permanent vers ce titre">¶</a></h2>
<p>À partir de GDAL 1.6.0, même quand PostGIS est activé, si l&#8217;utilisateur définit
la variable d&#8217;environnement</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PG_LIST_ALL_TABLES</span><span class="o">=</span><span class="n">YES</span>
</pre></div>
</div>
<p>(et ne définie pas &#8216;&#8217;tables=&#8217;&#8216;), toutes les tables attributaires des
utilisateurs et les vues nommées seront traitées comme des couches. Cependant,
les tables avec des colonnes de géométrie multiple seront seulement rapportées
une fois dans ce mode. Ainsi, cette variable est essentiellement utile lorsque
PostGIS est activé pour retrouver les tables sans données spatiales, ou les
vues sans entrée dans la table <em>geometry_columns</em>.</p>
<p>Dans tous les cas, tous les utilisateurs peuvent réaliser des requêtes
explicitement avec <em>GetLayerByName()</em>.</p>
<p>Les tables attributaires (non spatiale) peuvent être accédée, et retourneront
les objets avec leurs attributs, mais sans géométrie. Si la table possède un
champ <em>wkb_geometry</em>, elle sera traitée comme une table spatiale. Le type du
champ est inspecté pour déterminer comment il doit être lu. Cela peut être un
champ géométrique PostGIS, qui est supposé être au format WKT de l&#8217;OGC, ou de
type BYTEA ou OID auquel cas il est utilisé comme une source de géométrie WKB
de l&#8217;OGC.</p>
<p>À partir de GDAL 1.6.0, les tables héritées de tables spatiales sont gérées.</p>
<p>S&#8217;il y a un champ <em>ogc_fid</em>, il sera utilisé pour définir l&#8217;id de l&#8217;objet des
géométries, et ne sera pas traité comme un champ régulier.</p>
<p>Le nom de la couche peut être de la forme <em>schema.table</em>. Le schéma doit
exister, et l&#8217;utilisateur doit avoir les droits d&#8217;écriture pour la cible et le
schéma public.</p>
<p>À partir de GDAL 1.7.0, i l&#8217;utilisateur définie la variable d&#8217;environnement
<em>PG_SKIP_VIEWS=YES</em> (et ne spécifie pas <em>tables=</em>), seul les tables de
l&#8217;utilisateur seront traité comme couche. L&#8217;action par défaut est d&#8217;inclure les
vues. Cette variable est particulièrement utile lorsque vous devez copier les
données dans un autre format tout en évitant la redondance des données à partir
des vues.</p>
</div>
<div class="section" id="vues-nommees">
<h2>Vues nommées<a class="headerlink" href="#vues-nommees" title="Lien permanent vers ce titre">¶</a></h2>
<p>Quand PostGIS est activé pour la base de données accédée, les vues nommées sont
gérées, si et seulement si une entré dans la table <em>geometry_columns</em> existe.
Mais, notez que la fonction SQL <em>AddGeometryColumn()</em> n&#8217;accepte pas l&#8217;ajout
d&#8217;une entrée pour une vue (seulement pour les tables attributaires). Il faut
donc le réaliser à la main avec une requête comme :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&quot;INSERT INTO geometry_columns VALUES (&#39;&#39;, &#39;public&#39;, &#39;name_of_my_view&#39;, &#39;name_of_geometry_column&#39;, 2, 4326, &#39;POINT&#39;);&quot;</span>
</pre></div>
</div>
<p>À partir de GDAL 1.6.0, il est également possible d&#8217;utiliser des vues nommées
sans insertion dans la table <em>geometry_columns</em>. Pour cela, vous devez définir
explicitement le nom de la vue dans l&#8217;option <em>table=</em> de la chaîne de
connections. Voyez au-dessus. La contrainte est qu&#8217;OGR ne sera pas capable de
rapporter un SRS valide et de retrouver le bon type de la géométrie.</p>
</div>
<div class="section" id="recuper-le-fid-d-une-feature-nouvellement-inseree">
<h2>Récuper le FID d&#8217;une feature nouvellement insérée<a class="headerlink" href="#recuper-le-fid-d-une-feature-nouvellement-inseree" title="Lien permanent vers ce titre">¶</a></h2>
<p>À partir d&#8217;OGR 1.8.0 et des bases de données PostgreSQL &gt;= 8.2, le FID d&#8217;une
feature (i.e. habtiduellement la valeur de la colonne <em>OGC_FID</em> pour une feature)
insérée dans une table avec <em>CreateFeature()</em>, en mode non copie, sera récupéré
à partir de la base et peut être obtenu avec <em>GetFID()</em>. Un effet de bord de ce
nouveau comportement est que vous devez faire attention si vous réutiliser le
même objet feature dans une loupe qui réalise des intersections. Après la première
itération, le FID sera définie à une valeur non null, à la deuxième itération donc,
<em>CreateFeature()</em> tentera d&#8217;insérer la nouvelle feature avec le FID de l&#8217;ancienne
feature, ce qui échouera puique vous ne pouvez pas insérer deux features avec le
même FID. Dans ce cas vous devez explicitement reseter le FID avant l&#8217;appel de
<em>CreateFeature()</em>, ou utiliser un objet feature tout neuf.</p>
<p>Court exemple en Python :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">feat</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">feat</span><span class="o">.</span><span class="n">SetFID</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c"># Reset FID to null value</span>
    <span class="n">lyr</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;The feature has been assigned FID </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">feat</span><span class="o">.</span><span class="n">GetFID</span><span class="p">())</span>
</pre></div>
</div>
<p>ou :</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">feat</span> <span class="o">=</span> <span class="n">ogr</span><span class="o">.</span><span class="n">Feature</span><span class="p">(</span><span class="n">lyr</span><span class="o">.</span><span class="n">GetLayerDefn</span><span class="p">())</span>
    <span class="n">lyr</span><span class="o">.</span><span class="n">CreateFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;The feature has been assigned FID </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">feat</span><span class="o">.</span><span class="n">GetFID</span><span class="p">())</span>
</pre></div>
</div>
<p>Le comportement d&#8217;OGR &lt; 1.8.0 peut être obtenu en définissant l&#8217;option de
configuration <em>OGR_PG_RETRIEVE_FID</em> à FALSE.</p>
</div>
<div class="section" id="avertissements">
<h2>Avertissements<a class="headerlink" href="#avertissements" title="Lien permanent vers ce titre">¶</a></h2>
<ul class="simple">
<li>La logique de reconnaissance des types est pour l&#8217;instant assez pauvre. Les
types <em>INT*</em> et <em>NUMERIC(width,0)</em> sont mappé en <em>integer</em>, les types <em>FLOAT</em>
et <em>NUMERIC(width,precision&gt;0)</em> sont mappé en <em>real</em>, date, time, timestamp
et datetime sont gérés comme des types <em>date</em> et tous les autres types sont
simplement traités comme des <em>strings</em>.</li>
<li>Un objet séquence appelé <em>&lt;tablename&gt;_ogc_fid_seq</em> est créé pour les nouvelles tables
(couche).</li>
<li>La lecture séquentielle est réalisée dans une seule transaction. Toutes
tentatives d&#8217;écriture dans une couche lors d&#8217;une lecture séquentielle
entraîneront probablement un <em>BEGIN</em> alors qu&#8217;il est déjà dans une
transaction et renverra un message d&#8217;erreur.</li>
</ul>
<div class="section" id="exemples-avances">
<h3>Exemples avancés<a class="headerlink" href="#exemples-avances" title="Lien permanent vers ce titre">¶</a></h3>
<ul>
<li><p class="first">Cet exemple montre l&#8217;utilisation de <tt class="docutils literal"><span class="pre">ogrinfo</span></tt> pour lister seulement les
couches définies par l&#8217;option <em>tables=</em> (à partir de GDAL 1.6.0).</p>
<div class="highlight-python"><pre>ogrinfo -ro PG:'dbname=warmerda tables=table1,table2'</pre>
</div>
</li>
<li><p class="first">Cet exemple montre l&#8217;utilisation de <tt class="docutils literal"><span class="pre">ogrinfo</span></tt> pour requêter une table &#8216;foo&#8217;
avec des colonnes à géométrie multiple (&#8216;geom1&#8217; et &#8216;geom2&#8217;) (à partir de GDAL
1.6.0) :</p>
<div class="highlight-python"><pre>ogrinfo -ro -al PG:dbname=warmerda 'foo(geom2)'</pre>
</div>
</li>
<li><p class="first">Cet exemple montre comment lister seulement les couches dans les schémas
<em>apt200810</em> et <em>apt200812</em>. Les noms des couches seront préfixés par le nom
du schéma auquel ils appartiennent (à partir de GDAL 1.7.0) :</p>
<div class="highlight-python"><pre>ogrinfo -ro PG:'dbname=warmerda schemas=apt200810,apt200812'</pre>
</div>
</li>
<li><p class="first">Cet exemple montre l&#8217;utilisation de <tt class="docutils literal"><span class="pre">ogrinfo</span></tt> pour lister seulement les
couches dans le schéma nommé <em>apt200810</em>. Notez que les noms des couches ne
seront pas préfixés par <em>apt200810</em> puisque seul un schéma est listé (à partir
de GDAL 1.7.0) :</p>
<div class="highlight-python"><pre>ogrinfo -ro PG:'dbname=warmerda schemas=apt200810'</pre>
</div>
</li>
<li><p class="first">Cet exemple montre comment convertir un ensemble de shapefile dans le
répertoire <em>apt200810</em> dans un schéma <em>apt200810</em> existant de Postgres. Dans
cet exemple, nous pourrions utiliser l&#8217;option <em>the schemas=</em> à la place (à
partir de GDAL 1.7.0) :</p>
<div class="highlight-python"><pre>ogr2ogr -f PostgreSQL "PG:dbname=warmerda active_schema=apt200810" apt200810</pre>
</div>
</li>
<li><p class="first">Cet exemple montre comment convertir toutes les tables dans le schéma
<em>apt200810</em> comme un ensemble de shapefile dans le répertoire <em>apt200810</em>.
Notez que les noms des couches ne seront pas préfixés par <em>apt200810</em> puisque
seul un schéma est listé (à partir de GDAL 1.7.0) :</p>
<div class="highlight-python"><pre>ogr2ogr apt200810 PG:'dbname=warmerda schemas=apt200810'</pre>
</div>
</li>
<li><p class="first">Cet exemple montre comment écraser une table existante dans un schéma existant.
Notez que l&#8217;utilisation de l&#8217;option &#8216;&#8217;-nln&#8217;&#8217; pour définir le nom de la couche
qualifiée :</p>
<div class="highlight-python"><pre>ogr2ogr -overwrite -f PostgreSQL "PG:dbname=warmerda" mytable.shp mytable -nln myschema.mytable</pre>
</div>
</li>
</ul>
<p>Notez que l&#8217;utilisation de <em>-lco SCHEMA=mytable</em> à la place de <em>-nln</em> n&#8217;aurait
pas fonctionner dans ce cas (voir bug
<a class="reference external" href="http://trac.osgeo.org/gdal/ticket/2821">#2821</a> pour plus de détails).</p>
<p>Si vous désirez écraser plusieurs tables à la fois localisées dans un schéma,
l&#8217;option <em>-nln</em> n&#8217;est pas plus appropriée, il peut être donc plus facile
d&#8217;utiliser la chaîne de connexions <em>active_schema</em> (à partir de GDAL 1.7.0).
L&#8217;exemple suivant écrasera, si nécessaire, toutes les tables PostgreSQL
correspondantes à un ensemble de shapefile dans un répertoire <em>apt200810</em> :</p>
<div class="highlight-python"><pre>ogr2ogr -overwrite -f PostgreSQL "PG:dbname=warmerda active_schema=apt200810" apt200810</pre>
</div>
</div>
<div class="section" id="voir-egalement">
<h3>Voir également<a class="headerlink" href="#voir-egalement" title="Lien permanent vers ce titre">¶</a></h3>
<ul class="simple">
<li><a class="reference internal" href="pg.html#gdal-ogr-formats-pg"><em>PostgreSQL / PostGIS</em></a></li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>


      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../index.html">GDAL v1.9.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
    <a href="http://creativecommons.org/licenses/by/2.0/fr/deed.fr">Licence Creative Common BY</a>
    <!--
      &copy; Copyright 2011, Yves Jacolin.-->
      Créé avec <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>